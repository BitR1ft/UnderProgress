version: '3.8'

# ==============================================================================
# AutoPenTest AI - Month 2 Docker Compose Configuration
# Professional FYP Implementation with Network Segmentation & Service Isolation
# ==============================================================================

services:
  # ============================================================================
  # DATABASE TIER - Isolated Data Layer
  # ============================================================================
  
  # PostgreSQL Database - Relational Data
  postgres:
    image: postgres:16-alpine
    container_name: autopentestai-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-autopentestai}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-autopentestai_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-autopentestai}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
      # Performance tuning
      POSTGRES_MAX_CONNECTIONS: "200"
      POSTGRES_SHARED_BUFFERS: "256MB"
      POSTGRES_EFFECTIVE_CACHE_SIZE: "1GB"
      POSTGRES_WORK_MEM: "16MB"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - postgres-backups:/backups
      - ./backend/init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - db-network
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-autopentestai} -d ${POSTGRES_DB:-autopentestai}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Neo4j Graph Database - Attack Graph & Relationships
  neo4j:
    image: neo4j:5.15-community
    container_name: autopentestai-neo4j
    restart: unless-stopped
    environment:
      # Authentication
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-autopentestai_dev_password}
      
      # APOC Plugin Configuration
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_apoc_export_file_enabled: "true"
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_apoc_import_file_use__neo4j__config: "true"
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*,gds.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*,gds.*"
      
      # Memory Configuration (optimized for graph operations)
      NEO4J_dbms_memory_heap_initial__size: "512m"
      NEO4J_dbms_memory_heap_max__size: "2g"
      NEO4J_dbms_memory_pagecache_size: "1g"
      NEO4J_dbms_memory_transaction_total_max: "512m"
      
      # Performance Tuning
      NEO4J_dbms_transaction_timeout: "60s"
      NEO4J_dbms_lock_acquisition_timeout: "60s"
      NEO4J_dbms_query__cache__size: "512"
      
      # Connector Configuration
      NEO4J_dbms_connector_bolt_listen__address: ":7687"
      NEO4J_dbms_connector_http_listen__address: ":7474"
      NEO4J_dbms_connector_bolt_advertised__address: ":7687"
      
      # Security
      NEO4J_dbms_security_allow__csv__import__from__file__urls: "true"
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"  # HTTP
      - "${NEO4J_BOLT_PORT:-7687}:7687"  # Bolt
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-import:/var/lib/neo4j/import
      - neo4j-plugins:/plugins
      - neo4j-backups:/backups
    networks:
      - db-network
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 3G
        reservations:
          cpus: '0.5'
          memory: 1G

  # ============================================================================
  # APPLICATION TIER - Core Services
  # ============================================================================
  
  # FastAPI Backend - Main API Server
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: "3.11"
    container_name: autopentestai-backend
    restart: unless-stopped
    environment:
      # Application
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PROJECT_NAME: "AutoPenTest AI"
      VERSION: "1.0.0"
      DEBUG: ${DEBUG:-false}
      
      # Database URLs
      DATABASE_URL: postgresql://${POSTGRES_USER:-autopentestai}:${POSTGRES_PASSWORD:-autopentestai_dev_password}@postgres:5432/${POSTGRES_DB:-autopentestai}
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-autopentestai_dev_password}
      
      # Security
      SECRET_KEY: ${SECRET_KEY:-change_this_to_a_very_long_random_secret_key}
      ALGORITHM: ${ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      
      # CORS
      BACKEND_CORS_ORIGINS: ${BACKEND_CORS_ORIGINS:-["http://localhost:3000","http://localhost:8000"]}
      
      # API Configuration
      API_HOST: "0.0.0.0"
      API_PORT: "8000"
      
      # Docker SDK (for container orchestration)
      DOCKER_HOST: "unix:///var/run/docker.sock"
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      - ./backend:/app:ro
      - ./logs:/var/log/autopentestai
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For Docker SDK
      - backend-cache:/app/.cache
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    networks:
      - backend-network
      - frontend-network
      - tools-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M
    profiles: ["dev", "prod"]

  # Next.js Frontend - User Interface
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NODE_VERSION: "20"
        NEXT_TELEMETRY_DISABLED: "1"
    container_name: autopentestai-frontend
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-ws://localhost:8000}
      NEXT_TELEMETRY_DISABLED: "1"
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    volumes:
      - ./frontend:/app:ro
      - frontend-cache:/app/.next
      - /app/node_modules
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - frontend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    profiles: ["dev", "prod"]

  # ============================================================================
  # SECURITY TOOLS TIER - Isolated Security Tools
  # ============================================================================
  
  # Kali Linux Tools Container - Base Security Tools
  kali-tools:
    build:
      context: ./docker/kali
      dockerfile: Dockerfile
    container_name: autopentestai-kali-tools
    restart: unless-stopped
    privileged: false
    cap_add:
      - NET_RAW
      - NET_ADMIN
    environment:
      TOOLS_VERSION: "2024.1"
    volumes:
      - kali-tools-data:/root
      - scan-results:/results
      - tool-configs:/configs:ro
    networks:
      - tools-network
    command: tail -f /dev/null  # Keep container running
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
    profiles: ["tools", "dev", "prod"]

  # Reconnaissance Container - Dedicated Recon Tools
  recon-container:
    build:
      context: ./docker/recon
      dockerfile: Dockerfile
    container_name: autopentestai-recon
    restart: unless-stopped
    privileged: false
    cap_add:
      - NET_RAW
    environment:
      PYTHONUNBUFFERED: "1"
      RECON_OUTPUT_DIR: "/results/recon"
    volumes:
      - ./backend/app/tools:/app/tools:ro
      - scan-results:/results
      - tool-configs:/configs:ro
    networks:
      - tools-network
    command: tail -f /dev/null  # Keep container running
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    profiles: ["tools", "dev", "prod"]

# ==============================================================================
# NETWORK CONFIGURATION - Segmented Architecture
# ==============================================================================

networks:
  # Database Network - Only accessible by backend services
  db-network:
    driver: bridge
    name: autopentestai-db-network
    internal: true  # Not exposed to host
    ipam:
      driver: default
      config:
        - subnet: 172.20.1.0/24
  
  # Backend Network - API and backend services
  backend-network:
    driver: bridge
    name: autopentestai-backend-network
    ipam:
      driver: default
      config:
        - subnet: 172.20.2.0/24
  
  # Frontend Network - Frontend to backend communication
  frontend-network:
    driver: bridge
    name: autopentestai-frontend-network
    ipam:
      driver: default
      config:
        - subnet: 172.20.3.0/24
  
  # Tools Network - Isolated security tools
  tools-network:
    driver: bridge
    name: autopentestai-tools-network
    ipam:
      driver: default
      config:
        - subnet: 172.20.4.0/24

# ==============================================================================
# VOLUME CONFIGURATION - Data Persistence
# ==============================================================================

volumes:
  # Database Volumes
  postgres-data:
    driver: local
    name: autopentestai-postgres-data
  postgres-backups:
    driver: local
    name: autopentestai-postgres-backups
  neo4j-data:
    driver: local
    name: autopentestai-neo4j-data
  neo4j-logs:
    driver: local
    name: autopentestai-neo4j-logs
  neo4j-import:
    driver: local
    name: autopentestai-neo4j-import
  neo4j-plugins:
    driver: local
    name: autopentestai-neo4j-plugins
  neo4j-backups:
    driver: local
    name: autopentestai-neo4j-backups
  
  # Application Volumes
  backend-cache:
    driver: local
    name: autopentestai-backend-cache
  frontend-cache:
    driver: local
    name: autopentestai-frontend-cache
  
  # Tools & Results Volumes
  kali-tools-data:
    driver: local
    name: autopentestai-kali-data
  scan-results:
    driver: local
    name: autopentestai-scan-results
  tool-configs:
    driver: local
    name: autopentestai-tool-configs
